<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Event</title>
    <link rel="stylesheet" href="create-events.css" />
  </head>

  <body>
    <header class="header">
      <h1>Event<span class="header-text">Hive</span></h1>
      <nav>
        <a href="../AdminDashboard/admin-dashboard.html" class="signup"
          >All Events</a
        >
        <a href="../logout.php" class="signup">Logout</a>
      </nav>
    </header>

    <div class="container">
      <h1 class="title">Create Event</h1>

      <form id="createEventForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="eventCategory">Category</label>
          <select id="eventCategory" name="eventCategory">
            <option value="event">Event</option>
            <option value="conference">Conference</option>
          </select>
        </div>
        <div class="form-group">
          <label for="eventTitle">Title</label>
          <input
            type="text"
            id="eventTitle"
            name="eventTitle"
            placeholder="Enter event title"
            required
          />
        </div>

        <div class="form-group">
          <label for="eventVenue">Venue</label>
          <input
            type="text"
            id="eventVenue"
            name="eventVenue"
            placeholder="Enter event venue"
            required
          />
        </div>

        <div class="row">
          <div class="form-group">
            <label for="startTime">Start Time</label>
            <input type="time" id="startTime" name="startTime" required />
          </div>
          <div class="form-group">
            <label for="endTime">End Time</label>
            <input type="time" id="endTime" name="endTime" required />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" name="startDate" required />
          </div>
          <div class="form-group">
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" name="endDate" required />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="eventType">Type</label>
            <select id="eventType" name="eventType">
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="form-group">
            <label for="eventPrice">Price ($)</label>
            <input
              type="number"
              id="eventPrice"
              name="eventPrice"
              placeholder="Enter price"
              min="0"
              disabled
            />
          </div>
        </div>

        <h2 class="section-title">Event Description</h2>

        <div class="form-group">
          <label for="eventImage">Event Image</label>
          <div class="image-upload">
            <input
              type="file"
              id="eventImage"
              name="eventImage"
              accept="image/*"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="eventDescription">Event Description</label>
          <textarea
            id="eventDescription"
            name="eventDescription"
            placeholder="Type here..."
            required
          ></textarea>
        </div>

        <button type="submit">Create Event</button>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch("../check_session.php")
          .then((response) => response.json())
          .then((data) => {
            if (!data.is_logged_in || data.email !== "admin@gmail.com") {
              window.location.href = "/Event-Hive/Sign_in/signin.html";
            }
          })
          .catch((error) => {
            console.error("Error fetching session:", error);
            window.location.href = "/Event-Hive/Sign_in/signin.html";
          });
      });
      document
        .getElementById("eventType")
        .addEventListener("change", function () {
          const priceInput = document.getElementById("eventPrice");
          priceInput.disabled = this.value === "free";
          if (this.value === "free") priceInput.value = "";
        });

      document
        .getElementById("createEventForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const formData = new FormData(this); 
          try {
            const response = await fetch("create_event.php", {
              method: "POST",
              body: formData,
            });

            const result = await response.json(); 

            if (result.status === "success") {
              alert(result.message);
              window.location.href = "/Event-Hive/allEvents/all-events.html"; 
            } else {
              alert(result.message); 
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Something went wrong. Please try again.");
          }
        });

        document.addEventListener("DOMContentLoaded", async function () {
  const urlParams = new URLSearchParams(window.location.search);
  const eventTitle = urlParams.get("title");
  
  if (eventTitle) {
    try {
      const response = await fetch(`../AdminDashboard/fetch_event.php?title=${encodeURIComponent(eventTitle)}`);
      const textResponse = await response.text();

      
      let eventData;
      try {
        eventData = JSON.parse(textResponse);
      } catch (error) {
        console.error("Invalid JSON Response:", textResponse);
      }
      
      if (eventData && eventData.status === "success") {
        populateForm(eventData.event);
      } else {
        alert("Event not found.");
        window.location.href = "/Event-Hive/AdminDashboard/admin-dashboard.html";
      }
    } catch (error) {
      console.error("Error fetching event data:", error);
      alert("Failed to load event details.");
    }
  }

  function populateForm(event) {
    document.getElementById("eventCategory").value = event.category || "";
    document.getElementById("eventTitle").value = event.title || "";
    document.getElementById("eventVenue").value = event.venue || "";
    document.getElementById("startTime").value = event.start_time?.slice(0, 5) || "00:00";
    document.getElementById("endTime").value = event.end_time?.slice(0, 5) || "00:00";
    document.getElementById("startDate").value = event.start_date || "";
    document.getElementById("endDate").value = event.end_date || "";
    document.getElementById("eventType").value = event.type || "";
    document.getElementById("eventPrice").value = event.type === "paid" ? event.price || "0.00" : "";
    document.getElementById("eventDescription").value = event.description || "";
    
    if (event.image) {
      const imagePreview = document.createElement("img");
      imagePreview.src = event.image;
      imagePreview.style.maxWidth = "200px";
      document.getElementById("eventImage").parentElement.appendChild(imagePreview);
    }
  }

  document.getElementById("createEventForm").addEventListener("submit", async function (event) {
    event.preventDefault();
    const formData = new FormData(this);
    
    if (eventTitle) {
      formData.append("oldTitle", eventTitle);
      try {
        const response = await fetch("../AdminDashboard/update_event.php", { method: "POST", body: formData });
        const result = await response.json();
        alert(result.message);
        if (result.status === "success") {
          window.location.href = "/Event-Hive/allEvents/all-events.html";
        }
      } catch (error) {
        console.error("Error updating event:", error);
        alert("Failed to update event.");
      }
    } else {
      try {
        const response = await fetch("create_event.php", { method: "POST", body: formData });
        const result = await response.json();
        alert(result.message);
        if (result.status === "success") {
          window.location.href = "/Event-Hive/allEvents/all-events.html";
        }
      } catch (error) {
        console.error("Error creating event:", error);
        alert("Something went wrong.");
      }
    }
  });

  document.getElementById("eventType").addEventListener("change", function () {
    const eventPriceInput = document.getElementById("eventPrice");
    eventPriceInput.disabled = this.value !== "paid";
  });
});

    </script>
  </body>
</html>
